> Original Source: kiro_01/specs/note-taking-feature/tasks.md

# Implementation Plan: Note Taking Feature

## Overview

This implementation plan breaks down the note-taking feature into discrete, incremental coding tasks. Each task builds on previous work, with testing integrated throughout to validate functionality early. The implementation follows the existing application architecture and UI patterns.

## Tasks

- [x] 1. Create HTML structure for note-taking UI components
  - Add note button (mobile toggle and desktop button) to index.html
  - Add note modal with header, body, and footer sections
  - Add textarea for note editing
  - Add preview section for formatted content
  - Add upload files button and dropdown with temporary file upload site links
  - Add instruction text about temporary files and markdown format
  - Add save and clear buttons in modal footer
  - _Requirements: 1.1, 1.2, 2.3, 2.4, 2.5, 5.1, 5.3, 5.4, 5.5, 5.6, 5.7, 5.9_

- [ ] 2. Create CSS styles for note-taking components
  - [x] 2.1 Create note.css file with styles for note button and modal
    - Style mobile note toggle button (fixed position, right side, bottom-middle)
    - Style desktop note button (fixed position, bottom-right corner)
    - Style note modal for responsive behavior (full-screen mobile, popup desktop)
    - Style textarea with appropriate sizing and styling
    - Style preview section with proper formatting
    - Style upload sites dropdown and instruction text
    - Style save and clear buttons
    - Add responsive breakpoints at 768px for mobile/desktop switching
    - _Requirements: 1.1, 1.2, 2.1, 2.2, 7.1, 7.2_
  
  - [ ]* 2.2 Write unit tests for CSS responsive behavior
    - Test note button positioning at mobile viewport (< 768px)
    - Test note button positioning at desktop viewport (â‰¥ 768px)
    - Test modal full-screen rendering at mobile viewport
    - Test modal popup rendering at desktop viewport
    - _Requirements: 1.1, 1.2, 2.1, 2.2, 7.1, 7.2_

- [ ] 3. Create NoteManager module (notes.js)
  - [x] 3.1 Implement core NoteManager structure and initialization
    - Create notes.js file with NoteManager object
    - Implement init() method to set up event listeners
    - Add event listeners for note button clicks (mobile and desktop)
    - Add event listeners for modal close button
    - Add event listeners for save and clear buttons
    - Add event listener for upload files button toggle
    - Add event listener for textarea input (for preview updates)
    - Implement authentication state checking
    - _Requirements: 1.3, 1.4, 2.5, 4.2, 5.2_
  
  - [ ]* 3.2 Write unit tests for NoteManager initialization
    - Test init() sets up all event listeners correctly
    - Test note button click opens modal
    - Test close button click closes modal
    - Test upload files button toggles dropdown
    - Test authentication state checking
    - _Requirements: 1.3, 1.4, 2.5, 5.2_

- [ ] 4. Implement modal visibility and UI interactions
  - [x] 4.1 Implement openModal() and closeModal() methods
    - Create openModal() to show modal and load user's note
    - Create closeModal() to hide modal
    - Add focus management (focus textarea when modal opens)
    - Add keyboard support (Escape key to close)
    - Update ARIA attributes for accessibility
    - _Requirements: 1.3, 2.5_
  
  - [ ]* 4.2 Write property test for modal visibility toggle
    - **Property 5: Modal Visibility Toggle**
    - **Validates: Requirements 1.3, 2.5**
  
  - [ ]* 4.3 Write unit tests for modal interactions
    - Test Escape key closes modal
    - Test textarea receives focus when modal opens
    - Test ARIA attributes are updated correctly
    - _Requirements: 1.3, 2.5_

- [ ] 5. Implement text formatting and preview functionality
  - [x] 5.1 Implement updatePreview() method
    - Create updatePreview() method that takes note content as input
    - Use Utils.escapeAndLinkify() to format content
    - Update preview section with formatted HTML
    - Handle empty content with placeholder message
    - Wire up textarea input event to trigger preview updates
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 4.2_
  
  - [ ]* 5.2 Write property test for note content formatting consistency
    - **Property 1: Note Content Formatting Consistency**
    - **Validates: Requirements 3.1, 3.2, 3.3, 3.4**
  
  - [ ]* 5.3 Write property test for real-time preview update
    - **Property 6: Real-time Preview Update**
    - **Validates: Requirements 4.2**
  
  - [ ]* 5.4 Write unit tests for preview edge cases
    - Test empty content shows placeholder
    - Test very long content renders correctly
    - Test special characters are escaped properly
    - _Requirements: 3.1, 3.2, 3.4, 4.2_

- [x] 6. Checkpoint - Ensure UI and preview functionality works
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 7. Implement Firebase persistence operations
  - [x] 7.1 Implement loadNote() method
    - Create loadNote(userId) method to fetch note from Firestore
    - Query /users/{userId} document for noteContent field
    - Handle case where noteContent doesn't exist (new user)
    - Update textarea with loaded content
    - Update preview with formatted content
    - Handle Firestore errors gracefully
    - _Requirements: 4.1, 6.2_
  
  - [x] 7.2 Implement saveNote() method
    - Create saveNote(userId, content) method to persist note to Firestore
    - Validate content size (max 1MB)
    - Update /users/{userId} document with noteContent field
    - Add noteUpdatedAt timestamp field
    - Show success message to user
    - Handle Firestore errors with user-friendly messages
    - _Requirements: 6.1, 6.5_
  
  - [x] 7.3 Implement clearNote() method
    - Create clearNote(userId) method to remove note content
    - Show confirmation dialog before clearing
    - Update Firestore to set noteContent to empty string
    - Clear textarea and preview in UI
    - Show success message to user
    - _Requirements: 4.3, 4.4, 6.4_
  
  - [ ]* 7.4 Write property test for note persistence round trip
    - **Property 2: Note Persistence Round Trip**
    - **Validates: Requirements 6.1, 6.2**
  
  - [ ]* 7.5 Write property test for user data isolation
    - **Property 3: User Data Isolation**
    - **Validates: Requirements 4.5, 6.3**
  
  - [ ]* 7.6 Write property test for clear operation completeness
    - **Property 4: Clear Operation Completeness**
    - **Validates: Requirements 4.3, 6.4**
  
  - [ ]* 7.7 Write property test for error notification on save failure
    - **Property 8: Error Notification on Save Failure**
    - **Validates: Requirements 6.5**
  
  - [ ]* 7.8 Write unit tests for Firebase error handling
    - Test permission-denied error shows appropriate message
    - Test network unavailable error shows appropriate message
    - Test content size validation
    - Test handling of missing noteContent field
    - _Requirements: 6.5_

- [ ] 8. Implement auto-save functionality
  - [x] 8.1 Implement debounced auto-save
    - Create autoSave property to store debounce timer
    - Implement setupAutoSave() method with 500ms debounce
    - Wire up textarea input event to trigger auto-save
    - Ensure auto-save only runs for authenticated users
    - Add visual indicator for save status (optional)
    - _Requirements: 6.1_
  
  - [ ]* 8.2 Write unit tests for auto-save behavior
    - Test auto-save is debounced (doesn't fire immediately)
    - Test auto-save fires after 500ms of inactivity
    - Test rapid typing doesn't trigger multiple saves
    - Test auto-save only runs for authenticated users
    - _Requirements: 6.1_

- [ ] 9. Implement upload sites dropdown functionality
  - [x] 9.1 Implement dropdown toggle logic
    - Create toggleUploadDropdown() method
    - Wire up upload files button click to toggle dropdown
    - Add click-outside-to-close functionality
    - Ensure all links open in new tabs (target="_blank")
    - _Requirements: 5.2, 5.8_
  
  - [ ]* 9.2 Write property test for upload dropdown toggle
    - **Property 7: Upload Dropdown Toggle**
    - **Validates: Requirements 5.2**
  
  - [ ]* 9.3 Write unit tests for dropdown functionality
    - Test dropdown visibility toggles on button click
    - Test clicking outside dropdown closes it
    - Test all links have target="_blank" attribute
    - Test all five upload sites are present
    - _Requirements: 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8_

- [ ] 10. Implement authentication and access control
  - [x] 10.1 Implement authentication state handling
    - Add onAuthStateChanged listener in init()
    - Show/hide note button based on authentication state
    - Disable note functionality for unauthenticated users
    - Load user's note when authenticated
    - _Requirements: 1.4, 4.5_
  
  - [ ]* 10.2 Write property test for authenticated access control
    - **Property 9: Authenticated Access Control**
    - **Validates: Requirements 1.4**
  
  - [ ]* 10.3 Write unit tests for access control
    - Test note button hidden for unauthenticated users
    - Test note button visible for authenticated users
    - Test note operations fail gracefully without authentication
    - _Requirements: 1.4, 4.5_

- [x] 11. Checkpoint - Ensure all core functionality works
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 12. Add responsive behavior and accessibility
  - [x] 12.1 Implement responsive functionality
    - Ensure note button switches between mobile/desktop versions at 768px breakpoint
    - Ensure modal switches between full-screen/popup at 768px breakpoint
    - Test all functionality works at various viewport sizes
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [x] 12.2 Add accessibility features
    - Add ARIA labels to all interactive elements
    - Add aria-expanded attribute to note button
    - Add role="dialog" and aria-modal="true" to modal
    - Add aria-labelledby to modal referencing title
    - Ensure keyboard navigation works (Tab, Escape)
    - Test with screen reader (manual testing)
    - _Requirements: 1.3, 2.5_
  
  - [ ]* 12.3 Write property test for responsive functionality preservation
    - **Property 10: Responsive Functionality Preservation**
    - **Validates: Requirements 7.3, 7.4, 7.5**
  
  - [ ]* 12.4 Write unit tests for accessibility
    - Test ARIA attributes are present and correct
    - Test keyboard navigation (Tab order, Escape to close)
    - Test focus management
    - _Requirements: 1.3, 2.5_

- [ ] 13. Integrate with existing application
  - [x] 13.1 Wire up NoteManager with app initialization
    - Import notes.js in index.html (after other JS modules)
    - Call NoteManager.init() in app.js after authentication setup
    - Ensure note button appears in correct z-index layer
    - Test note feature doesn't interfere with existing features
    - _Requirements: 1.1, 1.2, 1.3, 1.4_
  
  - [ ]* 13.2 Write integration tests
    - Test note feature works alongside tasks and events
    - Test note button doesn't overlap with other floating buttons
    - Test modal doesn't interfere with other modals
    - Test authentication flow works correctly
    - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 14. Update Firebase security rules
  - [x] 14.1 Add security rules for noteContent field
    - Add read/write rules for /users/{userId}/noteContent
    - Ensure users can only access their own notes
    - Add validation for noteContent field (string type, max 1MB size)
    - Test security rules with Firebase Emulator
    - _Requirements: 6.1, 6.2, 6.3, 6.4_
  
  - [ ]* 14.2 Write unit tests for security rules
    - Test authenticated user can read/write their own note
    - Test authenticated user cannot read/write other users' notes
    - Test unauthenticated user cannot read/write any notes
    - Test noteContent size validation
    - _Requirements: 6.1, 6.2, 6.3_

- [ ] 15. Final testing and polish
  - [ ]* 15.1 Run all property-based tests
    - Run all 10 property tests with 100 iterations each
    - Verify all properties pass consistently
    - Fix any failures discovered
  
  - [ ]* 15.2 Run all unit tests
    - Run complete unit test suite
    - Verify 80%+ code coverage
    - Fix any failures discovered
  
  - [x] 15.3 Manual testing across devices
    - Test on mobile devices (iOS, Android)
    - Test on desktop browsers (Chrome, Firefox, Safari, Edge)
    - Test responsive breakpoints
    - Test with slow network connection
    - Test with Firestore offline
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [x] 15.4 Accessibility testing
    - Test with screen reader (NVDA, JAWS, VoiceOver)
    - Test keyboard-only navigation
    - Run axe-core accessibility audit
    - Fix any accessibility issues found
    - _Requirements: 1.3, 2.5_

- [x] 16. Final checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

## Notes

- Tasks marked with `*` are optional and can be skipped for faster MVP
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties (minimum 100 iterations each)
- Unit tests validate specific examples and edge cases
- Integration tests ensure the feature works with existing application components
- Manual testing validates real-world usage across devices and browsers
