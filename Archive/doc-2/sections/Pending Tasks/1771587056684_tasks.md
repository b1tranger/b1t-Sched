> Original Source: kiro_01/specs/faculty-role-privileges/tasks.md

# Implementation Plan: Faculty Role and Privileges

## Overview

This implementation adds a new Faculty role to the application with department-based organization, specialized profile settings, and Google Classroom content creation capabilities. The implementation follows the existing codebase patterns using JavaScript, Firebase Firestore, and the Google Classroom API.

## Tasks

- [x] 1. Update Firestore data model and security rules
  - Add `role` field to users collection (values: "Student", "CR", "Admin", "Faculty")
  - Add `isFaculty` boolean field to users collection for backward compatibility
  - Update Firestore security rules to allow Faculty users to create tasks
  - Update security rules to restrict Faculty token access to owner and admins
  - Create `facultyTokens` collection with security rules
  - _Requirements: 1.2, 1.3, 8.3_

- [x] 2. Implement role management in database module
  - [x] 2.1 Add `getUserRole()` function to db.js
    - Fetch user document and return role field
    - Handle legacy `isAdmin`, `isCR` fields for backward compatibility
    - _Requirements: 1.1, 1.2_
  
  - [x] 2.2 Add `assignFacultyRole()` function to db.js
    - Validate admin permissions before assignment
    - Update user document with `role: "Faculty"` and `isFaculty: true`
    - Set semester and section to null for Faculty users
    - _Requirements: 1.1, 1.2, 1.4_
  
  - [x] 2.3 Add `removeFacultyRole()` function to db.js
    - Validate admin permissions
    - Update user document to remove Faculty role
    - Revert to Student role by default
    - _Requirements: 1.5_

- [x] 3. Create Faculty profile management
  - [x] 3.1 Update Profile.loadProfile() to handle Faculty users
    - Check if user has Faculty role
    - Skip semester/section loading for Faculty users
    - Load only department field
    - _Requirements: 2.1, 4.3_
  
  - [x] 3.2 Update Profile.renderFacultyProfileUI()
    - Render semester field as readonly with "Not Available For Faculty" text
    - Render section field as readonly with "Not Available For Faculty" text
    - Keep department field editable
    - _Requirements: 4.1, 4.2, 4.3_
  
  - [x] 3.3 Update Profile.handleSaveProfile() for Faculty users
    - Skip semester/section validation for Faculty users
    - Allow only department updates
    - Remove 30-day cooldown for Faculty users
    - _Requirements: 4.4_

- [x] 4. Implement Faculty task management
  - [x] 4.1 Update task creation to support Faculty users
    - Modify task creation form to detect Faculty role
    - Associate tasks with Faculty user's department only
    - Set `addedByRole: "Faculty"` field on task documents
    - _Requirements: 3.1_
  
  - [x] 4.2 Update task rendering to group Faculty tasks by department
    - Modify UI.renderTasks() to handle Faculty-created tasks
    - Display department badge for Faculty tasks
    - Group Faculty tasks separately from student tasks
    - _Requirements: 3.2, 3.3_
  
  - [x] 4.3 Update task filtering for Faculty view
    - Add department-based filtering for Faculty users
    - Remove semester/section filters from Faculty UI
    - _Requirements: 3.4, 10.5_
  
  - [x] 4.4 Update task edit permissions for Faculty
    - Allow Faculty users to edit their own tasks
    - Allow admins to edit any Faculty task
    - Prevent other users from editing Faculty tasks
    - _Requirements: 9.1, 9.2_

- [ ] 5. Create Faculty Classroom interface module
  - [x] 5.1 Create facultyClassroom.js module
    - Initialize Faculty Classroom interface
    - Set up event listeners for Faculty controls
    - Detect Faculty role and render appropriate UI
    - _Requirements: 5.1, 5.5_
  
  - [ ] 5.2 Implement Faculty Classroom UI rendering
    - Create Faculty-specific interface with creation controls
    - Add "Create Post" button
    - Add "Create Assignment" button
    - Hide creation controls for non-Faculty users
    - _Requirements: 5.2, 5.3, 5.4_
  
  - [ ] 5.3 Create post creation form
    - Build form with title, description, and materials fields
    - Add course selection dropdown
    - Add publish/draft toggle
    - Implement form validation
    - _Requirements: 6.3_
  
  - [ ] 5.4 Create assignment creation form
    - Build form with title, description, due date, and points fields
    - Add course selection dropdown
    - Add submission type options
    - Implement form validation
    - _Requirements: 7.3, 7.6_

- [ ] 6. Implement Google Classroom API integration for Faculty
  - [ ] 6.1 Update Classroom module OAuth scopes
    - Add `classroom.announcements` scope for Faculty users
    - Add `classroom.coursework.students` scope for Faculty users
    - Detect Faculty role and request appropriate scopes
    - _Requirements: 8.2_
  
  - [ ] 6.2 Implement Faculty OAuth token storage
    - Create `storeFacultyTokens()` function in db.js
    - Encrypt tokens before storing in Firestore
    - Store access token, refresh token, and expiration
    - _Requirements: 8.3_
  
  - [ ] 6.3 Implement Faculty OAuth token retrieval
    - Create `getFacultyTokens()` function in db.js
    - Decrypt tokens after retrieval
    - Check token expiration
    - _Requirements: 8.3_
  
  - [ ] 6.4 Implement token refresh mechanism
    - Create `refreshFacultyToken()` function
    - Detect 401 errors and trigger refresh
    - Update stored tokens after refresh
    - _Requirements: 8.5_
  
  - [ ] 6.5 Implement Google Classroom post creation API call
    - Create `createClassroomPost()` function
    - Send POST request to Google Classroom API
    - Handle API response and errors
    - Display success/error messages
    - _Requirements: 6.1, 6.2, 6.4, 6.5_
  
  - [ ] 6.6 Implement Google Classroom assignment creation API call
    - Create `createClassroomAssignment()` function
    - Send POST request to Google Classroom API
    - Handle API response and errors
    - Display success/error messages
    - _Requirements: 7.1, 7.2, 7.4, 7.5_

- [ ] 7. Update UI components for Faculty role
  - [ ] 7.1 Update navigation to show Faculty-specific options
    - Add Faculty dashboard link if user is Faculty
    - Hide semester/section filters for Faculty users
    - _Requirements: 10.1, 10.5_
  
  - [ ] 7.2 Update dashboard rendering for Faculty users
    - Display department-based content grouping
    - Show Faculty-created tasks prominently
    - Add quick access to Classroom content creation
    - _Requirements: 10.2_
  
  - [ ] 7.3 Update task list rendering for Faculty
    - Highlight Faculty-created tasks with distinct styling
    - Add Faculty badge to tasks created by Faculty users
    - _Requirements: 10.3_
  
  - [ ] 7.4 Implement role-based UI component rendering
    - Create `isFaculty()` helper function in App module
    - Update UI.toggleAdminControls() to handle Faculty role
    - Conditionally render Faculty-specific controls
    - _Requirements: 10.4_

- [ ] 8. Add admin interface for Faculty role management
  - [ ] 8.1 Create Faculty role assignment UI in admin panel
    - Add "Assign Faculty Role" button to user management
    - Create modal for Faculty role assignment
    - Display current role and allow role change
    - _Requirements: 1.1_
  
  - [ ] 8.2 Implement Faculty role assignment handler
    - Validate admin permissions
    - Call `assignFacultyRole()` function
    - Display success/error messages
    - Refresh user list after assignment
    - _Requirements: 1.2, 1.4_
  
  - [ ] 8.3 Implement Faculty role removal handler
    - Add "Remove Faculty Role" option
    - Confirm before removing role
    - Call `removeFacultyRole()` function
    - _Requirements: 1.5_

- [ ] 9. Implement error handling and validation
  - [ ] 9.1 Add role assignment authorization checks
    - Validate admin status before role operations
    - Return descriptive error messages
    - Log unauthorized attempts
    - _Requirements: 1.4_
  
  - [ ] 9.2 Add Faculty profile validation
    - Prevent Faculty users from editing semester/section
    - Validate department field is not empty
    - Display field-specific error messages
    - _Requirements: 4.1, 4.2, 4.4_
  
  - [ ] 9.3 Add Google Classroom API error handling
    - Handle 401 (token expired) errors with refresh
    - Handle 403 (insufficient permissions) errors
    - Handle 404 (course not found) errors
    - Handle 429 (rate limit) errors
    - Display user-friendly error messages
    - _Requirements: 6.4, 7.4_
  
  - [ ] 9.4 Add post/assignment validation
    - Validate required fields before submission
    - Check title length (max 1000 chars)
    - Check description length (max 30000 chars)
    - Validate due date is in the future
    - Validate points are positive numbers
    - _Requirements: 6.3, 7.3_

- [ ] 10. Update app initialization and routing
  - [ ] 10.1 Update App.init() to load Faculty role
    - Check user role on initialization
    - Set `App.isFaculty` flag
    - Load Faculty-specific modules if needed
    - _Requirements: 1.3_
  
  - [ ] 10.2 Update Router to handle Faculty routes
    - Add Faculty dashboard route
    - Add Faculty Classroom route
    - Restrict routes based on role
    - _Requirements: 10.1_

- [ ] 11. Add CSS styling for Faculty UI elements
  - [ ] 11.1 Create Faculty-specific styles
    - Style Faculty badge for tasks
    - Style Faculty Classroom interface
    - Style post/assignment creation forms
    - Add Faculty color scheme (distinct from admin/CR)
    - _Requirements: 5.5, 10.3_
  
  - [ ] 11.2 Update responsive styles for Faculty UI
    - Ensure Faculty controls work on mobile
    - Test Faculty forms on different screen sizes
    - _Requirements: 5.5_

- [ ] 12. Testing and documentation
  - [ ] 12.1 Test Faculty role assignment flow
    - Test admin can assign Faculty role
    - Test non-admin cannot assign Faculty role
    - Test Faculty role persists across sessions
    - _Requirements: 1.1, 1.2, 1.3, 1.4_
  
  - [ ] 12.2 Test Faculty profile management
    - Test semester/section fields are readonly
    - Test department field is editable
    - Test profile updates work correctly
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  
  - [ ] 12.3 Test Faculty task creation and management
    - Test Faculty can create tasks
    - Test tasks are associated with department
    - Test Faculty can edit their own tasks
    - Test task filtering works correctly
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 9.1, 9.2_
  
  - [ ] 12.4 Test Google Classroom integration
    - Test Faculty OAuth authentication
    - Test post creation
    - Test assignment creation
    - Test token refresh
    - Test error handling
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 8.1, 8.2, 8.3, 8.4, 8.5_
  
  - [ ] 12.5 Test Faculty UI rendering
    - Test Faculty-specific controls appear
    - Test non-Faculty users don't see Faculty controls
    - Test responsive design
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 13. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

## Notes

- This implementation builds on the existing Firebase/Firestore infrastructure
- Google Classroom API integration requires OAuth 2.0 setup in Google Cloud Console
- Faculty tokens should be encrypted before storage for security
- Consider implementing a migration script for existing users being assigned Faculty role
- The implementation maintains backward compatibility with existing `isAdmin` and `isCR` fields
- Faculty role is additive - it doesn't replace existing role system but extends it
