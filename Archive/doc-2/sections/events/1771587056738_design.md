> Original Source: kiro_01/specs/firebase-cr-permissions/design.md

# Design Document: Firebase CR Permissions Fix

## Overview

This design addresses a bug in the Firebase Firestore security rules where CR (Class Representative) users cannot add events. The current implementation incorrectly restricts CR users by department, but the requirement is to restrict them by semester. This design updates the security rules to allow CR users to create, edit, and delete events for their assigned semester only.

## Architecture

The solution modifies the Firebase Firestore security rules (firestore.rules file) without requiring changes to the application code. The architecture follows Firebase's declarative security model:

1. **Helper Functions**: Utility functions that check user authentication, roles, and semester assignments
2. **Event Collection Rules**: Match rules that control create, read, update, and delete operations on the events collection
3. **Semester Validation**: Logic to ensure CR users can only operate on events within their assigned semester

## Components and Interfaces

### Helper Functions

**getUserSemester()**
- Purpose: Retrieves the semester assigned to the authenticated CR user
- Returns: String representing the user's semester (e.g., "Fall2024", "Spring2025")
- Usage: Called during event creation and update operations to validate semester matching

**isCR()**
- Purpose: Checks if the authenticated user has the CR role
- Returns: Boolean indicating CR status
- Current Implementation: Checks if user document has `isCR == true`
- Usage: Used in event operation rules to determine if CR-specific logic applies

**isAdmin()**
- Purpose: Checks if the authenticated user has the Admin role
- Returns: Boolean indicating Admin status
- Current Implementation: Checks if user document has `isAdmin == true`
- Usage: Used to bypass all restrictions for Admin users

**isSignedIn()**
- Purpose: Checks if a user is authenticated
- Returns: Boolean indicating authentication status
- Usage: Base check for all protected operations

### Event Collection Rules

**Read Operations**
- All authenticated users can read events
- No changes needed from current implementation

**Create Operations**
- Admin: Can create events for any semester
- CR: Can create events only if `event.semester == user.semester`
- CR: Must set `createdBy` field to their own user ID
- CR: Must provide all required fields (title, description, date, department, semester, createdBy)
- Student: Cannot create events

**Update Operations**
- Admin: Can update any event
- CR: Can update only events where `event.createdBy == user.uid`
- CR: Cannot change the `createdBy` field
- CR: Cannot change the `semester` field to a different semester than their assigned semester
- Student: Cannot update events

**Delete Operations**
- Admin: Can delete any event
- CR: Can delete only events where `event.createdBy == user.uid`
- Student: Cannot delete events

## Data Models

### User Document (users/{userId})
```
{
  uid: string,
  email: string,
  name: string,
  department: string,
  semester: string,        // Required for CR users
  isAdmin: boolean,
  isCR: boolean,
  isBlocked: boolean,
  // ... other fields
}
```

### Event Document (events/{eventId})
```
{
  title: string,
  description: string,
  date: timestamp,
  department: string,
  semester: string,        // Must match CR user's semester
  createdBy: string,       // User ID of creator
  // ... other fields
}
```

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a systemâ€”essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*


### Property 1: CR Semester-Locked Creation
*For any* CR user with an assigned semester and any event document, the Firestore rules should allow event creation if and only if the event's semester field matches the CR user's assigned semester.

**Validates: Requirements 1.1, 1.2**

### Property 2: CR Ownership Requirement on Creation
*For any* CR user attempting to create an event, the Firestore rules should allow creation if and only if the event's createdBy field is set to that CR user's ID.

**Validates: Requirements 1.3**

### Property 3: Required Fields Validation
*For any* user attempting to create an event, the Firestore rules should deny creation if any required field (title, description, date, department, semester, createdBy) is missing or empty.

**Validates: Requirements 1.4, 5.3**

### Property 4: CR Ownership Requirement on Edit
*For any* CR user attempting to edit an event, the Firestore rules should allow the edit if and only if the event's createdBy field matches that CR user's ID.

**Validates: Requirements 2.1, 2.2**

### Property 5: CreatedBy Field Immutability
*For any* user attempting to edit an event, the Firestore rules should deny the edit if the update attempts to modify the createdBy field.

**Validates: Requirements 2.3**

### Property 6: Semester Field Edit Restriction
*For any* CR user attempting to edit an event's semester field, the Firestore rules should deny the edit if the new semester value differs from the CR user's assigned semester.

**Validates: Requirements 2.4**

### Property 7: CR Ownership Requirement on Delete
*For any* CR user attempting to delete an event, the Firestore rules should allow the deletion if and only if the event's createdBy field matches that CR user's ID.

**Validates: Requirements 3.1, 3.2**

### Property 8: Role-Based Access Control
*For any* event operation (create, edit, delete):
- Student users should be denied all write operations
- Admin users should be allowed all operations regardless of semester or creator
- Unauthenticated users should be denied all write operations

**Validates: Requirements 4.1, 4.2, 4.3**

### Property 9: Read Access for Authenticated Users
*For any* authenticated user regardless of role, the Firestore rules should allow read access to all events.

**Validates: Requirements 4.4**

### Property 10: Semester Field Validation
*For any* user attempting to create or update an event, the Firestore rules should deny the operation if the semester field is not a non-empty string.

**Validates: Requirements 5.1**

## Error Handling

### Authentication Errors
- **Unauthenticated Access**: When `request.auth` is null, all write operations return permission denied
- **Missing User Document**: When a user document doesn't exist in the users collection, role checks fail and operations are denied

### Validation Errors
- **Missing Required Fields**: When required fields are absent, the create operation is denied with a permission error
- **Invalid Semester**: When semester field is empty or not a string, the operation is denied
- **Semester Mismatch**: When a CR user attempts to create/edit an event with a semester different from their assigned semester, the operation is denied

### Authorization Errors
- **Ownership Violation**: When a CR user attempts to edit/delete an event they didn't create, the operation is denied
- **Role Restriction**: When a Student user attempts any write operation, the operation is denied
- **Field Modification**: When attempting to modify immutable fields (createdBy), the operation is denied

### Error Response Pattern
All Firebase security rule violations return a standard permission denied error:
```
FirebaseError: Missing or insufficient permissions
```

The client application should handle these errors gracefully and provide user-friendly messages based on the operation context.

## Testing Strategy

### Unit Testing Approach

Unit tests will focus on specific scenarios and edge cases for each rule:

**Authentication Tests**:
- Test unauthenticated user access (should be denied)
- Test authenticated user with missing user document (should be denied)

**Role-Based Tests**:
- Test Student user attempting create/edit/delete (should be denied)
- Test Admin user performing all operations (should be allowed)
- Test CR user with valid semester match (should be allowed)

**Semester Validation Tests**:
- Test CR user creating event with matching semester (should be allowed)
- Test CR user creating event with different semester (should be denied)
- Test event with empty semester field (should be denied)
- Test event with null semester field (should be denied)

**Ownership Tests**:
- Test CR user editing their own event (should be allowed)
- Test CR user editing another user's event (should be denied)
- Test CR user deleting their own event (should be allowed)
- Test CR user deleting another user's event (should be denied)

**Field Immutability Tests**:
- Test editing event with createdBy modification (should be denied)
- Test CR user changing semester to different value (should be denied)
- Test CR user changing semester to same value (should be allowed)

**Required Fields Tests**:
- Test creating event with all required fields (should be allowed)
- Test creating event with missing title (should be denied)
- Test creating event with missing createdBy (should be denied)

### Property-Based Testing Approach

Property-based tests will validate universal properties across randomized inputs using a Firebase Rules testing library (e.g., @firebase/rules-unit-testing for JavaScript/TypeScript):

**Test Configuration**:
- Minimum 100 iterations per property test
- Random generation of user roles, semesters, and event data
- Each test references its corresponding design property

**Property Test Implementation**:

Each correctness property will be implemented as a property-based test that:
1. Generates random test data (users, events, operations)
2. Executes the operation against the Firebase Rules emulator
3. Verifies the expected permission result
4. Tags the test with: **Feature: firebase-cr-permissions, Property N: [property text]**

**Test Data Generators**:
- User generator: Creates users with random roles (Student, CR, Admin), semesters, and IDs
- Event generator: Creates events with random fields including semester, createdBy, and content
- Operation generator: Creates random create/read/update/delete operations

**Property Test Examples**:

Property 1 test will:
- Generate random CR users with assigned semesters
- Generate random events with various semester values
- Attempt creation operations
- Verify: allowed if semesters match, denied otherwise

Property 4 test will:
- Generate random CR users and events
- Generate random edit operations
- Verify: allowed only when CR user ID matches event's createdBy field

Property 8 test will:
- Generate random users with different roles
- Generate random write operations
- Verify: Students denied, Admins allowed, unauthenticated denied

### Testing Tools

**Firebase Rules Emulator**:
- Local emulator for testing security rules without deploying
- Provides fast feedback during development
- Supports unit and property-based testing

**Testing Library**:
- @firebase/rules-unit-testing (for JavaScript/TypeScript)
- Provides utilities for initializing test environments
- Supports authenticated and unauthenticated contexts

**Property-Based Testing Library**:
- fast-check (for JavaScript/TypeScript)
- Provides random data generation
- Supports configurable iteration counts

### Test Execution

Tests should be run:
- Before deploying rules to production
- After any rule modifications
- As part of CI/CD pipeline
- Minimum 100 iterations for each property test to ensure comprehensive coverage
