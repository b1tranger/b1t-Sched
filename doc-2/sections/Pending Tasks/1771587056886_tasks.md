> Original Source: kiro_01/specs/firebase-cr-permissions/tasks.md

# Implementation Plan: Firebase CR Permissions Fix

## Overview

This implementation plan addresses the bug in Firebase Firestore security rules that prevents CR users from adding events. The fix updates the firestore.rules file to allow CR users to create, edit, and delete events for their assigned semester only. The implementation includes updating the security rules and creating comprehensive tests to verify the fix.

## Tasks

- [x] 1. Update Firebase security rules for CR event creation
  - Modify the events collection create rule to check user's semester instead of department
  - Add getUserSemester() helper function to retrieve CR user's assigned semester
  - Update create rule to validate event.semester matches user.semester for CR users
  - Ensure createdBy field is set to the authenticated user's ID
  - Add validation for required fields (title, description, date, department, semester, createdBy)
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 5.1, 5.3_

- [x] 2. Update Firebase security rules for CR event editing
  - Update the events collection update rule to check ownership (createdBy matches user ID)
  - Add validation to prevent modification of createdBy field during updates
  - Add validation to prevent CR users from changing semester to a different value than their assigned semester
  - Ensure Admin users can still edit any event
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 3. Update Firebase security rules for CR event deletion
  - Update the events collection delete rule to check ownership (createdBy matches user ID)
  - Ensure Admin users can still delete any event
  - _Requirements: 3.1, 3.2_

- [x] 4. Verify role-based access control rules
  - Confirm Student users cannot create, edit, or delete events
  - Confirm Admin users can perform all operations
  - Confirm unauthenticated users are denied all write operations
  - Confirm all authenticated users can read events
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 5. Set up Firebase Rules testing environment
  - Install @firebase/rules-unit-testing package
  - Install fast-check package for property-based testing
  - Create test configuration file for Firebase emulator
  - Set up test helper functions for creating test users and events
  - Create utility functions for initializing authenticated and unauthenticated contexts
  - _Requirements: All (testing infrastructure)_

- [x] 6. Checkpoint - Ensure rules are updated and test environment is ready
  - Ensure all tests pass, ask the user if questions arise.

- [ ]* 7. Write property-based tests for CR event creation rules
  - [ ]* 7.1 Write property test for CR semester-locked creation
    - **Property 1: CR Semester-Locked Creation**
    - **Validates: Requirements 1.1, 1.2**
    - Generate random CR users with assigned semesters
    - Generate random events with various semester values
    - Verify creation allowed only when semesters match
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 1**
  
  - [ ]* 7.2 Write property test for CR ownership requirement on creation
    - **Property 2: CR Ownership Requirement on Creation**
    - **Validates: Requirements 1.3**
    - Generate random CR users and events
    - Attempt creation with various createdBy values
    - Verify creation allowed only when createdBy matches user ID
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 2**
  
  - [ ]* 7.3 Write property test for required fields validation
    - **Property 3: Required Fields Validation**
    - **Validates: Requirements 1.4, 5.3**
    - Generate random events with missing or empty required fields
    - Verify creation is denied when any required field is missing
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 3**

- [ ]* 8. Write property-based tests for CR event editing rules
  - [ ]* 8.1 Write property test for CR ownership requirement on edit
    - **Property 4: CR Ownership Requirement on Edit**
    - **Validates: Requirements 2.1, 2.2**
    - Generate random CR users and events
    - Attempt edits by various users
    - Verify edits allowed only when user ID matches createdBy
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 4**
  
  - [ ]* 8.2 Write property test for createdBy field immutability
    - **Property 5: CreatedBy Field Immutability**
    - **Validates: Requirements 2.3**
    - Generate random events and edit attempts
    - Attempt to modify createdBy field
    - Verify edits are denied when createdBy is changed
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 5**
  
  - [ ]* 8.3 Write property test for semester field edit restriction
    - **Property 6: Semester Field Edit Restriction**
    - **Validates: Requirements 2.4**
    - Generate random CR users and events
    - Attempt to change semester field to various values
    - Verify edits denied when new semester differs from user's semester
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 6**

- [ ]* 9. Write property-based tests for CR event deletion rules
  - [ ]* 9.1 Write property test for CR ownership requirement on delete
    - **Property 7: CR Ownership Requirement on Delete**
    - **Validates: Requirements 3.1, 3.2**
    - Generate random CR users and events
    - Attempt deletions by various users
    - Verify deletions allowed only when user ID matches createdBy
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 7**

- [ ]* 10. Write property-based tests for role-based access control
  - [ ]* 10.1 Write property test for role-based access control
    - **Property 8: Role-Based Access Control**
    - **Validates: Requirements 4.1, 4.2, 4.3**
    - Generate random users with different roles (Student, CR, Admin)
    - Generate random write operations (create, edit, delete)
    - Verify Students denied, Admins allowed, unauthenticated denied
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 8**
  
  - [ ]* 10.2 Write property test for read access
    - **Property 9: Read Access for Authenticated Users**
    - **Validates: Requirements 4.4**
    - Generate random authenticated users with various roles
    - Attempt read operations on random events
    - Verify all authenticated users can read events
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 9**

- [ ]* 11. Write property-based test for semester field validation
  - [ ]* 11.1 Write property test for semester field validation
    - **Property 10: Semester Field Validation**
    - **Validates: Requirements 5.1**
    - Generate random events with invalid semester values (empty, null, non-string)
    - Attempt create and update operations
    - Verify operations denied when semester is invalid
    - Configure test to run 100 iterations
    - Tag: **Feature: firebase-cr-permissions, Property 10**

- [ ]* 12. Write unit tests for edge cases and specific scenarios
  - [ ]* 12.1 Write unit tests for authentication edge cases
    - Test unauthenticated user attempting write operations
    - Test authenticated user with missing user document
    - _Requirements: 4.3_
  
  - [ ]* 12.2 Write unit tests for semester validation edge cases
    - Test event with empty string semester
    - Test event with null semester
    - Test event with non-string semester (number, object)
    - _Requirements: 5.1_
  
  - [ ]* 12.3 Write unit tests for field immutability
    - Test editing event while attempting to change createdBy
    - Test CR user changing semester to same value (should be allowed)
    - Test CR user changing semester to different value (should be denied)
    - _Requirements: 2.3, 2.4_
  
  - [ ]* 12.4 Write unit tests for Admin bypass
    - Test Admin creating event for any semester
    - Test Admin editing any user's event
    - Test Admin deleting any user's event
    - _Requirements: 4.2_

- [ ] 13. Final checkpoint - Run all tests and verify rules
  - Run all property-based tests (minimum 100 iterations each)
  - Run all unit tests
  - Verify all tests pass
  - Ensure all tests pass, ask the user if questions arise.

## Notes

- Tasks marked with `*` are optional and can be skipped for faster MVP
- The core fix is in tasks 1-4 (updating the security rules)
- Tasks 5-12 provide comprehensive test coverage
- Property-based tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- All tests use JavaScript with @firebase/rules-unit-testing and fast-check libraries
- Tests should be run against Firebase Rules emulator before deploying to production
