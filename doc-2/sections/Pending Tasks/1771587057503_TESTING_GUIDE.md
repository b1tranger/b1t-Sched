> Original Source: kiro_01/specs/push-notifications/TESTING_GUIDE.md

# Push Notifications System - Testing Guide

## Manual Testing Instructions

### Prerequisites
1. Firebase project must be configured and running
2. User must have a profile with department, semester, and section
3. Browser must support Web Notifications API

### Test 1: Permission Request Flow

**Steps:**
1. Clear browser data (localStorage and site permissions)
2. Log in to the application
3. Navigate to dashboard

**Expected Results:**
- Blue notification permission prompt appears at top of dashboard
- Prompt shows "Enable Notifications" button and "Not now" button
- Clicking "Enable Notifications" triggers browser permission dialog
- After granting permission, prompt disappears
- Console shows: "Notification system initialized" and "Firestore listeners initialized"

### Test 2: Task Notification

**Prerequisites:** Notification permission must be granted

**Steps:**
1. Log in as a regular user (note your department, semester, section)
2. Keep the application open
3. In another browser/tab, log in as Admin or CR
4. Add a new task for the same department/semester/section
5. Submit the task

**Expected Results:**
- Within 5 seconds, a browser notification appears
- Notification title shows the task title
- Notification body shows course and description
- Clicking notification focuses the window and navigates to dashboard
- Console shows: "New task detected: [task-id]" and "Task notification displayed: [task-id]"

### Test 3: Event Notification

**Prerequisites:** Notification permission must be granted

**Steps:**
1. Log in as a regular user (note your department)
2. Keep the application open
3. In another browser/tab, log in as Admin or CR
4. Add a new event for the same department (or 'ALL')
5. Submit the event

**Expected Results:**
- Within 5 seconds, a browser notification appears
- Notification title shows the event title
- Notification body shows date/time and description
- Clicking notification focuses the window and navigates to dashboard
- Console shows: "New event detected: [event-id]" and "Event notification displayed: [event-id]"

### Test 4: Permission Denied Flow

**Steps:**
1. Clear browser data
2. Log in to the application
3. Click "Enable Notifications" in the prompt
4. Click "Block" in the browser permission dialog

**Expected Results:**
- Browser-specific instructions appear in the prompt
- Instructions explain how to enable notifications in browser settings
- No notifications are displayed when tasks/events are added
- Console shows: "Notification permission not granted, skipping notification"

### Test 5: Initial Load Handling

**Prerequisites:** Notification permission must be granted

**Steps:**
1. Ensure there are existing tasks and events in Firestore
2. Log in to the application
3. Wait for dashboard to load

**Expected Results:**
- NO notifications appear for existing tasks/events
- Console shows: "Task listener initialized, monitoring for new tasks"
- Console shows: "Event listener initialized, monitoring for new events"
- Only NEW tasks/events added AFTER login trigger notifications

### Test 6: Logout Cleanup

**Prerequisites:** Notification permission must be granted, listeners active

**Steps:**
1. Log in and verify listeners are active (check console)
2. Log out of the application
3. In another browser/tab, add a new task/event

**Expected Results:**
- On logout, console shows: "All Firestore listeners unsubscribed"
- Console shows: "Notification system reset"
- NO notifications appear after logout
- Listeners are properly cleaned up

### Test 7: Content Truncation

**Steps:**
1. Log in with notification permission granted
2. Add a task with very long title (>50 characters) and description (>150 characters)

**Expected Results:**
- Notification appears with truncated content
- Title ends with "..." if truncated
- Body ends with "..." if truncated
- Truncation preserves word boundaries when possible

### Test 8: PWA Context

**Prerequisites:** Application must be installed as PWA

**Steps:**
1. Install the application as PWA
2. Open the PWA
3. Log in with notification permission granted
4. Add a new task/event from another device/browser

**Expected Results:**
- Notifications work identically in PWA as in browser
- Notification content and formatting are the same
- Clicking notification opens/focuses the PWA window

### Test 9: Browser API Not Supported

**Steps:**
1. Use browser developer tools to disable Notification API
2. Log in to the application

**Expected Results:**
- Console shows: "Web Notifications API not supported in this browser"
- Console shows: "Browser: [user agent string]"
- Application continues to function normally
- No errors or crashes

### Test 10: Multiple Notifications

**Steps:**
1. Log in with notification permission granted
2. Rapidly add 3-5 tasks in quick succession

**Expected Results:**
- All notifications appear
- Each notification has unique content
- No duplicate notifications
- All notifications can be clicked independently

## Browser Testing Matrix

Test the notification system in the following browsers:

| Browser | Version | Desktop | Mobile | Status |
|---------|---------|---------|--------|--------|
| Chrome | Latest | ✓ | ✓ | |
| Firefox | Latest | ✓ | ✓ | |
| Safari | Latest | ✓ | ✓ | |
| Edge | Latest | ✓ | ✓ | |
| Opera | Latest | ✓ | - | |

## Common Issues and Solutions

### Issue: Notifications not appearing
**Solution:**
1. Check `Notification.permission` in console
2. Verify listeners are active: Look for "Firestore listeners initialized"
3. Check browser notification settings
4. Ensure task/event matches user's department/semester/section

### Issue: Permission prompt not showing
**Solution:**
1. Clear localStorage: `localStorage.clear()`
2. Reset browser permissions for the site
3. Check if permission is already granted/denied

### Issue: Notifications for old items
**Solution:**
1. This indicates a bug in initial load detection
2. Check console for "Task/Event listener initialized" messages
3. Verify `isFirstSnapshot` flag is working correctly

### Issue: Listeners not cleaned up on logout
**Solution:**
1. Check console for "All Firestore listeners unsubscribed"
2. Verify `Auth.logout()` calls `FirestoreListenerManager.unsubscribeAll()`
3. Check for JavaScript errors in console

## Automated Testing (Future)

The following test files should be created:

1. `__tests__/permission-manager.test.js` - Unit tests for permission management
2. `__tests__/notification-content-formatter.test.js` - Unit tests for content formatting
3. `__tests__/notification-manager.test.js` - Unit tests for notification display
4. `__tests__/firestore-listener-manager.test.js` - Unit tests for Firestore listeners
5. `__tests__/notifications-integration.test.js` - Integration tests for full flows
6. `__tests__/notifications-properties.test.js` - Property-based tests using fast-check

## Performance Testing

Monitor the following metrics:
- Time from task/event creation to notification display (should be <5 seconds)
- Memory usage with active listeners
- CPU usage when notifications are displayed
- Number of Firestore reads (should not increase significantly)

## Security Testing

Verify the following:
- Users only receive notifications for their department/semester/section
- Notification content does not expose sensitive information
- Permission state is stored securely in localStorage
- No XSS vulnerabilities in notification content
