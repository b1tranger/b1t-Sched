> Original Source: kiro_01/specs/user-management-ui-updates/design.md

# Design Document: User Management UI Updates

## Overview

This design document specifies the technical implementation for enhancing the User Management interface in the admin panel. The enhancements include:

1. Adding Firebase Admin SDK functionality for password reset and user deletion
2. Implementing a compact filter popup interface
3. Optimizing action button sizing for consistency across devices
4. Creating backend API endpoints for secure administrative operations

The design maintains the existing single-page application architecture while adding new UI components and backend integration points.

## Architecture

### System Components

```
┌─────────────────────────────────────────────────────────────┐
│                     Admin Panel (Frontend)                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  User Management View                                 │  │
│  │  ├─ Add Filter Button (with active filter badge)     │  │
│  │  ├─ Filter Popup (modal overlay)                     │  │
│  │  └─ User List Container                              │  │
│  │     └─ User Cards                                     │  │
│  │        ├─ Send Password Reset Button                 │  │
│  │        ├─ Delete User Button (danger styled)         │  │
│  │        └─ Existing Action Buttons                    │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS API Calls
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Backend API (Firebase Functions)                │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  /api/admin/sendPasswordReset                        │  │
│  │  ├─ Validate admin authentication                    │  │
│  │  ├─ Generate password reset link                     │  │
│  │  └─ Send email via Firebase Auth                    │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  /api/admin/deleteUser                               │  │
│  │  ├─ Validate admin authentication                    │  │
│  │  ├─ Delete user from Firebase Auth                   │  │
│  │  └─ Clean up user data in Firestore                 │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Firebase Admin SDK
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Firebase Services                         │
│  ├─ Firebase Authentication                                 │
│  └─ Cloud Firestore                                         │
└─────────────────────────────────────────────────────────────┘
```


### Technology Stack

- **Frontend**: Vanilla JavaScript (ES6+), HTML5, CSS3
- **Backend**: Firebase Cloud Functions (Node.js)
- **Authentication**: Firebase Authentication
- **Database**: Cloud Firestore
- **Admin Operations**: Firebase Admin SDK

### Design Principles

1. **Progressive Enhancement**: New features integrate seamlessly with existing UI
2. **Security First**: All admin operations require server-side validation
3. **User Feedback**: Clear visual feedback for all operations (success/error states)
4. **Responsive Design**: Consistent experience across all device sizes
5. **Accessibility**: Proper ARIA labels and keyboard navigation support

## Components and Interfaces

### 1. Filter Popup Component

**Purpose**: Provide a compact, modal-based interface for user filtering

**HTML Structure**:
```html
<!-- Add Filter Button (replaces visible filter section) -->
<div class="filter-controls">
  <button id="add-filter-btn" class="btn btn-secondary">
    <i class="fas fa-filter"></i> Add Filter
    <span id="filter-badge" class="filter-badge" style="display: none;">0</span>
  </button>
</div>

<!-- Filter Popup Modal -->
<div id="filter-popup" class="modal filter-popup" style="display: none;">
  <div class="modal-content filter-popup-content">
    <div class="modal-header">
      <h3 class="modal-title">Filter Users</h3>
      <button id="close-filter-popup" class="btn btn-icon">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="filters-grid">
        <div class="form-group">
          <label for="filter-department">Department</label>
          <select id="filter-department" class="form-select">
            <option value="All">All Departments</option>
          </select>
        </div>
        <div class="form-group">
          <label for="filter-semester">Semester</label>
          <select id="filter-semester" class="form-select">
            <option value="All">All Semesters</option>
          </select>
        </div>
        <div class="form-group">
          <label for="filter-section">Section</label>
          <select id="filter-section" class="form-select">
            <option value="All">All Sections</option>
          </select>
        </div>
        <div class="form-group">
          <label for="filter-role">Role</label>
          <select id="filter-role" class="form-select">
            <option value="All">All Roles</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="clear-filters-btn" class="btn btn-secondary">
        <i class="fas fa-times"></i> Clear Filters
      </button>
      <button id="apply-filters-btn" class="btn btn-primary">
        <i class="fas fa-check"></i> Apply
      </button>
    </div>
  </div>
</div>
```


**CSS Styling**:
```css
/* Filter Popup Styles */
.filter-popup .modal-content {
  max-width: 600px;
  width: 90%;
}

.filter-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  background-color: var(--primary-maroon);
  color: var(--text-white);
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 8px;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-md);
}

/* Animation for popup */
.filter-popup {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
```

**JavaScript Interface**:
```javascript
class FilterPopup {
  constructor() {
    this.popup = document.getElementById('filter-popup');
    this.addFilterBtn = document.getElementById('add-filter-btn');
    this.closeBtn = document.getElementById('close-filter-popup');
    this.applyBtn = document.getElementById('apply-filters-btn');
    this.clearBtn = document.getElementById('clear-filters-btn');
    this.badge = document.getElementById('filter-badge');
    this.activeFilters = 0;
  }

  open() {
    this.popup.style.display = 'flex';
  }

  close() {
    this.popup.style.display = 'none';
  }

  updateBadge() {
    const filters = this.getActiveFilters();
    this.activeFilters = filters.length;
    
    if (this.activeFilters > 0) {
      this.badge.textContent = this.activeFilters;
      this.badge.style.display = 'inline-flex';
    } else {
      this.badge.style.display = 'none';
    }
  }

  getActiveFilters() {
    const filters = [];
    const dept = document.getElementById('filter-department').value;
    const sem = document.getElementById('filter-semester').value;
    const section = document.getElementById('filter-section').value;
    const role = document.getElementById('filter-role').value;

    if (dept !== 'All') filters.push('department');
    if (sem !== 'All') filters.push('semester');
    if (section !== 'All') filters.push('section');
    if (role !== 'All') filters.push('role');

    return filters;
  }

  clearFilters() {
    document.getElementById('filter-department').value = 'All';
    document.getElementById('filter-semester').value = 'All';
    document.getElementById('filter-section').value = 'All';
    document.getElementById('filter-role').value = 'All';
    this.updateBadge();
  }
}
```


### 2. Action Buttons Component

**Purpose**: Provide consistent, compact action buttons across all viewport sizes

**Updated User Card HTML**:
```html
<div class="user-card" data-user-id="${user.id}">
  <div class="user-card-header">
    <!-- Existing header content -->
  </div>
  <div class="user-card-actions">
    ${!user.isAdmin ? `
      <!-- New: Send Password Reset Button -->
      <button class="btn btn-sm btn-action send-reset-btn" 
              data-user-id="${user.id}" 
              data-user-email="${user.email}"
              title="Send password reset link">
        <i class="fas fa-key"></i> Reset Password
      </button>
      
      <!-- New: Delete User Button (danger styled) -->
      <button class="btn btn-sm btn-action btn-danger delete-user-btn" 
              data-user-id="${user.id}" 
              data-user-email="${user.email}"
              title="Delete user account">
        <i class="fas fa-trash-alt"></i> Delete
      </button>
      
      <!-- Existing buttons -->
      <button class="btn btn-sm btn-action toggle-cr-btn ${user.isCR ? 'active' : ''}" 
              data-user-id="${user.id}" 
              data-current-value="${user.isCR || false}">
        <i class="fas fa-user-graduate"></i> ${user.isCR ? 'Remove CR' : 'Make CR'}
      </button>
      
      <button class="btn btn-sm btn-action toggle-blocked-btn ${user.isBlocked ? 'active danger' : ''}" 
              data-user-id="${user.id}" 
              data-current-value="${user.isBlocked || false}">
        <i class="fas fa-${user.isBlocked ? 'unlock' : 'ban'}"></i> ${user.isBlocked ? 'Unblock' : 'Block'}
      </button>
    ` : '<span class="admin-protected">Admin account</span>'}
    
    <button class="btn btn-sm btn-action edit-user-btn" 
            data-user-id="${user.id}">
      <i class="fas fa-edit"></i> Edit
    </button>
  </div>
</div>
```

**CSS Styling**:
```css
/* Optimized Action Button Styles */
.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
  min-width: auto;
  white-space: nowrap;
}

.btn-action {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
}

.btn-action i {
  font-size: 12px;
}

/* Danger button styling for delete */
.btn-danger {
  background-color: #dc3545;
  color: white;
  border: 2px solid #dc3545;
}

.btn-danger:hover:not(:disabled) {
  background-color: #c82333;
  border-color: #bd2130;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
}

/* User card actions layout */
.user-card-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 12px;
  border-top: 1px solid var(--border-light);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .btn-sm {
    padding: 6px 10px;
    font-size: 12px;
  }
  
  .user-card-actions {
    gap: 6px;
  }
}
```


### 3. Confirmation Dialog Component

**Purpose**: Provide explicit confirmation for destructive actions

**HTML Structure**:
```html
<div id="delete-user-modal" class="modal" style="display: none;">
  <div class="modal-content modal-danger">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-exclamation-triangle"></i> Confirm User Deletion
      </h2>
      <button id="close-delete-modal" class="btn btn-icon">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p class="warning-text">
        You are about to permanently delete the user account:
      </p>
      <p class="user-email-display" id="delete-user-email"></p>
      <p class="warning-text">
        <strong>This action cannot be undone.</strong> All user data will be permanently removed.
      </p>
    </div>
    <div class="modal-footer">
      <button id="cancel-delete-user" class="btn btn-secondary">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button id="confirm-delete-user" class="btn btn-danger">
        <i class="fas fa-trash-alt"></i> Delete User
      </button>
    </div>
  </div>
</div>
```

**CSS Styling**:
```css
.modal-danger .modal-header {
  background-color: #f8d7da;
  border-bottom: 2px solid #dc3545;
}

.modal-danger .modal-title {
  color: #721c24;
}

.warning-text {
  color: #721c24;
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 12px;
}

.user-email-display {
  background-color: #f8f9fa;
  padding: 12px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 14px;
  color: #495057;
  margin: 12px 0;
  text-align: center;
  font-weight: 600;
}
```

**JavaScript Interface**:
```javascript
class DeleteUserDialog {
  constructor() {
    this.modal = document.getElementById('delete-user-modal');
    this.emailDisplay = document.getElementById('delete-user-email');
    this.confirmBtn = document.getElementById('confirm-delete-user');
    this.cancelBtn = document.getElementById('cancel-delete-user');
    this.closeBtn = document.getElementById('close-delete-modal');
    this.currentUserId = null;
  }

  open(userId, userEmail) {
    this.currentUserId = userId;
    this.emailDisplay.textContent = userEmail;
    this.modal.style.display = 'flex';
  }

  close() {
    this.modal.style.display = 'none';
    this.currentUserId = null;
    this.emailDisplay.textContent = '';
  }

  getUserId() {
    return this.currentUserId;
  }
}
```


### 4. Backend API Endpoints

**Purpose**: Provide secure server-side operations for admin functions

**Firebase Functions Structure**:
```
functions/
├── index.js                 # Main entry point
├── admin/
│   ├── sendPasswordReset.js # Password reset endpoint
│   └── deleteUser.js        # User deletion endpoint
├── middleware/
│   └── auth.js              # Authentication middleware
└── package.json
```

**API Endpoint: Send Password Reset**

```javascript
// functions/admin/sendPasswordReset.js
const admin = require('firebase-admin');

/**
 * Send password reset link to a user
 * POST /api/admin/sendPasswordReset
 * Body: { userId: string }
 * Headers: { Authorization: Bearer <token> }
 */
exports.sendPasswordReset = async (req, res) => {
  try {
    // Validate request method
    if (req.method !== 'POST') {
      return res.status(405).json({ 
        success: false, 
        error: 'Method not allowed' 
      });
    }

    // Verify admin authentication
    const token = req.headers.authorization?.split('Bearer ')[1];
    if (!token) {
      return res.status(401).json({ 
        success: false, 
        error: 'No authentication token provided' 
      });
    }

    const decodedToken = await admin.auth().verifyIdToken(token);
    const adminUid = decodedToken.uid;

    // Check if requesting user is admin
    const adminDoc = await admin.firestore()
      .collection('users')
      .doc(adminUid)
      .get();

    if (!adminDoc.exists || !adminDoc.data().isAdmin) {
      return res.status(403).json({ 
        success: false, 
        error: 'Insufficient permissions. Admin access required.' 
      });
    }

    // Get target user ID from request
    const { userId } = req.body;
    if (!userId) {
      return res.status(400).json({ 
        success: false, 
        error: 'User ID is required' 
      });
    }

    // Get user record
    const userRecord = await admin.auth().getUser(userId);
    
    // Generate password reset link
    const resetLink = await admin.auth().generatePasswordResetLink(userRecord.email);

    // Send email (Firebase handles this automatically)
    await admin.auth().sendPasswordResetEmail(userRecord.email);

    // Log the action
    await admin.firestore().collection('adminLogs').add({
      action: 'password_reset_sent',
      adminId: adminUid,
      targetUserId: userId,
      targetUserEmail: userRecord.email,
      timestamp: admin.firestore.FieldValue.serverTimestamp()
    });

    return res.status(200).json({ 
      success: true, 
      message: `Password reset link sent to ${userRecord.email}` 
    });

  } catch (error) {
    console.error('Error sending password reset:', error);
    
    if (error.code === 'auth/user-not-found') {
      return res.status(404).json({ 
        success: false, 
        error: 'User not found' 
      });
    }

    return res.status(500).json({ 
      success: false, 
      error: 'Failed to send password reset link: ' + error.message 
    });
  }
};
```


**API Endpoint: Delete User**

```javascript
// functions/admin/deleteUser.js
const admin = require('firebase-admin');

/**
 * Delete a user account
 * POST /api/admin/deleteUser
 * Body: { userId: string }
 * Headers: { Authorization: Bearer <token> }
 */
exports.deleteUser = async (req, res) => {
  try {
    // Validate request method
    if (req.method !== 'POST') {
      return res.status(405).json({ 
        success: false, 
        error: 'Method not allowed' 
      });
    }

    // Verify admin authentication
    const token = req.headers.authorization?.split('Bearer ')[1];
    if (!token) {
      return res.status(401).json({ 
        success: false, 
        error: 'No authentication token provided' 
      });
    }

    const decodedToken = await admin.auth().verifyIdToken(token);
    const adminUid = decodedToken.uid;

    // Check if requesting user is admin
    const adminDoc = await admin.firestore()
      .collection('users')
      .doc(adminUid)
      .get();

    if (!adminDoc.exists || !adminDoc.data().isAdmin) {
      return res.status(403).json({ 
        success: false, 
        error: 'Insufficient permissions. Admin access required.' 
      });
    }

    // Get target user ID from request
    const { userId } = req.body;
    if (!userId) {
      return res.status(400).json({ 
        success: false, 
        error: 'User ID is required' 
      });
    }

    // Prevent deletion of admin accounts
    const targetUserDoc = await admin.firestore()
      .collection('users')
      .doc(userId)
      .get();

    if (targetUserDoc.exists && targetUserDoc.data().isAdmin) {
      return res.status(403).json({ 
        success: false, 
        error: 'Cannot delete admin accounts' 
      });
    }

    // Get user record before deletion (for logging)
    const userRecord = await admin.auth().getUser(userId);
    const userEmail = userRecord.email;

    // Delete user from Firebase Authentication
    await admin.auth().deleteUser(userId);

    // Delete user document from Firestore
    await admin.firestore().collection('users').doc(userId).delete();

    // Log the action
    await admin.firestore().collection('adminLogs').add({
      action: 'user_deleted',
      adminId: adminUid,
      deletedUserId: userId,
      deletedUserEmail: userEmail,
      timestamp: admin.firestore.FieldValue.serverTimestamp()
    });

    return res.status(200).json({ 
      success: true, 
      message: `User ${userEmail} has been permanently deleted` 
    });

  } catch (error) {
    console.error('Error deleting user:', error);
    
    if (error.code === 'auth/user-not-found') {
      return res.status(404).json({ 
        success: false, 
        error: 'User not found' 
      });
    }

    return res.status(500).json({ 
      success: false, 
      error: 'Failed to delete user: ' + error.message 
    });
  }
};
```


**Main Functions Entry Point**:

```javascript
// functions/index.js
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const cors = require('cors')({ origin: true });

// Initialize Firebase Admin
admin.initializeApp();

// Import endpoint handlers
const { sendPasswordReset } = require('./admin/sendPasswordReset');
const { deleteUser } = require('./admin/deleteUser');

// Export Cloud Functions
exports.sendPasswordReset = functions.https.onRequest((req, res) => {
  cors(req, res, () => sendPasswordReset(req, res));
});

exports.deleteUser = functions.https.onRequest((req, res) => {
  cors(req, res, () => deleteUser(req, res));
});
```

**Frontend API Client**:

```javascript
// js/admin-api.js
class AdminAPI {
  constructor() {
    this.baseURL = 'https://us-central1-b1t-sched.cloudfunctions.net';
  }

  async getAuthToken() {
    const user = firebase.auth().currentUser;
    if (!user) {
      throw new Error('User not authenticated');
    }
    return await user.getIdToken();
  }

  async sendPasswordReset(userId) {
    try {
      const token = await this.getAuthToken();
      
      const response = await fetch(`${this.baseURL}/sendPasswordReset`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ userId })
      });

      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to send password reset');
      }

      return data;
    } catch (error) {
      console.error('API Error:', error);
      throw error;
    }
  }

  async deleteUser(userId) {
    try {
      const token = await this.getAuthToken();
      
      const response = await fetch(`${this.baseURL}/deleteUser`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ userId })
      });

      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to delete user');
      }

      return data;
    } catch (error) {
      console.error('API Error:', error);
      throw error;
    }
  }
}

// Export singleton instance
const adminAPI = new AdminAPI();
```


## Data Models

### Admin Log Entry

```javascript
{
  action: string,              // 'password_reset_sent' | 'user_deleted'
  adminId: string,             // UID of admin who performed action
  targetUserId: string,        // UID of affected user (optional for some actions)
  targetUserEmail: string,     // Email of affected user
  deletedUserId: string,       // UID of deleted user (for deletion logs)
  deletedUserEmail: string,    // Email of deleted user (for deletion logs)
  timestamp: Timestamp,        // Server timestamp
  metadata: object             // Additional context (optional)
}
```

### Filter State

```javascript
{
  department: string,          // 'All' | department name
  semester: string,            // 'All' | semester value
  section: string,             // 'All' | section value
  role: string,                // 'All' | 'Admin' | 'CR' | 'Blocked' | 'User'
  activeCount: number          // Number of active filters (not 'All')
}
```

### API Request/Response Models

**Send Password Reset Request**:
```javascript
{
  userId: string               // Firebase Auth UID
}
```

**Send Password Reset Response**:
```javascript
{
  success: boolean,
  message: string,             // Success message or error description
  error: string                // Error message (if success is false)
}
```

**Delete User Request**:
```javascript
{
  userId: string               // Firebase Auth UID
}
```

**Delete User Response**:
```javascript
{
  success: boolean,
  message: string,             // Success message or error description
  error: string                // Error message (if success is false)
}
```


## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system—essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Admin-only button visibility

*For any* user list containing users with different roles, action buttons for password reset and user deletion should only appear for non-admin users.

**Validates: Requirements 1.1, 2.1**

### Property 2: Password reset API integration

*For any* valid user ID, when the password reset button is clicked, the system should invoke the Firebase Admin SDK API with the correct user ID parameter.

**Validates: Requirements 1.2**

### Property 3: Success notification display

*For any* successful password reset or user deletion operation, the system should display a success notification containing the operation result message.

**Validates: Requirements 1.3, 2.5**

### Property 4: Error notification display

*For any* failed password reset or user deletion operation, the system should display an error notification containing the failure reason.

**Validates: Requirements 1.4, 2.6**

### Property 5: Admin action logging

*For any* password reset or user deletion operation, the system should create a log entry containing admin ID, target user ID, action type, and timestamp.

**Validates: Requirements 1.5, 2.7**

### Property 6: Danger button styling

*For any* delete user button rendered in the user list, the button should have red background color and a warning icon.

**Validates: Requirements 2.2**

### Property 7: Deletion confirmation requirement

*For any* delete button click, the system should display a confirmation dialog before proceeding with the deletion operation.

**Validates: Requirements 2.3**

### Property 8: User deletion API integration

*For any* confirmed deletion request, the system should invoke the Firebase Admin SDK delete user method with the correct user ID.

**Validates: Requirements 2.4**

### Property 9: Admin account deletion prevention

*For any* user with admin role, the delete button should not be rendered, and API calls to delete admin users should be rejected.

**Validates: Requirements 2.8**

### Property 10: Action button width consistency

*For any* viewport size (mobile, tablet, desktop), action buttons should have consistent width and maintain proper spacing.

**Validates: Requirements 3.1, 3.2, 3.3**

### Property 11: Filter popup open/close behavior

*For any* click on the "Add Filter" button, the filter popup should open and display all filter controls; clicking outside or pressing escape should close it.

**Validates: Requirements 4.3, 4.8**

### Property 12: Filter state persistence

*For any* set of applied filters, closing and reopening the filter popup should preserve the selected filter values.

**Validates: Requirements 4.6**

### Property 13: Active filter badge display

*For any* number of active filters (filters not set to "All"), the "Add Filter" button badge should display the correct count.

**Validates: Requirements 4.7**

### Property 14: Filter reset functionality

*For any* set of applied filters, clicking "Clear Filters" should reset all dropdowns to "All" and update the user list to show all users.

**Validates: Requirements 5.2, 5.3, 5.4**

### Property 15: API authentication validation

*For any* API request to password reset or user deletion endpoints, the system should verify the requesting user has admin privileges and reject non-admin requests.

**Validates: Requirements 6.2, 6.4, 6.5, 6.6**

### Property 16: Firebase Admin SDK method usage

*For any* password reset operation, the API should use `admin.auth().generatePasswordResetLink()` and `admin.auth().sendPasswordResetEmail()`; for user deletion, it should use `admin.auth().deleteUser()`.

**Validates: Requirements 6.7**

### Property 17: API response format

*For any* API request (success or failure), the response should contain a `success` boolean field and either a `message` or `error` field with descriptive text.

**Validates: Requirements 6.8**


## Error Handling

### Frontend Error Handling

**Network Errors**:
```javascript
async function handlePasswordReset(userId) {
  try {
    UI.showLoading(true);
    const result = await adminAPI.sendPasswordReset(userId);
    UI.showNotification('success', result.message);
  } catch (error) {
    if (error.message.includes('network')) {
      UI.showNotification('error', 'Network error. Please check your connection.');
    } else if (error.message.includes('permission')) {
      UI.showNotification('error', 'You do not have permission to perform this action.');
    } else {
      UI.showNotification('error', error.message);
    }
  } finally {
    UI.showLoading(false);
  }
}
```

**Validation Errors**:
- Empty user ID: Display "Invalid user ID" error
- Missing authentication token: Redirect to login
- Expired token: Refresh token automatically or prompt re-login

**User Feedback**:
- Loading states during API calls
- Success notifications with auto-dismiss (3 seconds)
- Error notifications with manual dismiss option
- Confirmation dialogs for destructive actions

### Backend Error Handling

**Authentication Errors**:
- 401 Unauthorized: Missing or invalid token
- 403 Forbidden: Valid token but insufficient permissions

**Validation Errors**:
- 400 Bad Request: Missing required parameters
- 404 Not Found: User does not exist

**Server Errors**:
- 500 Internal Server Error: Unexpected errors with logged details
- Graceful degradation: Return user-friendly error messages

**Error Response Format**:
```javascript
{
  success: false,
  error: "User-friendly error message",
  code: "ERROR_CODE",           // Optional: for programmatic handling
  details: "Technical details"   // Optional: only in development mode
}
```

### Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Admin logs - only admins can write, only admins can read
    match /adminLogs/{logId} {
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      allow write: if request.auth != null && 
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
  }
}
```


## Testing Strategy

### Dual Testing Approach

This feature requires both unit tests and property-based tests to ensure comprehensive coverage:

- **Unit tests**: Verify specific examples, edge cases, and error conditions
- **Property tests**: Verify universal properties across all inputs
- Both approaches are complementary and necessary for complete validation

### Unit Testing

**Focus Areas**:
- Specific UI interactions (button clicks, modal open/close)
- API endpoint responses with known inputs
- Error handling for specific failure scenarios
- Integration between components

**Example Unit Tests**:

```javascript
// Test: Filter popup opens on button click
test('Add Filter button opens filter popup', () => {
  const addFilterBtn = document.getElementById('add-filter-btn');
  const filterPopup = document.getElementById('filter-popup');
  
  addFilterBtn.click();
  
  expect(filterPopup.style.display).toBe('flex');
});

// Test: Delete confirmation dialog shows correct email
test('Delete dialog displays user email', () => {
  const dialog = new DeleteUserDialog();
  const testEmail = 'test@example.com';
  
  dialog.open('user123', testEmail);
  
  expect(dialog.emailDisplay.textContent).toBe(testEmail);
});

// Test: API returns 403 for non-admin users
test('Password reset API rejects non-admin users', async () => {
  const response = await fetch('/api/admin/sendPasswordReset', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer non-admin-token' },
    body: JSON.stringify({ userId: 'user123' })
  });
  
  expect(response.status).toBe(403);
  const data = await response.json();
  expect(data.error).toContain('Insufficient permissions');
});
```

### Property-Based Testing

**Testing Library**: Use `fast-check` for JavaScript property-based testing

**Configuration**:
- Minimum 100 iterations per property test
- Each test references its design document property
- Tag format: `Feature: user-management-ui-updates, Property {number}: {property_text}`

**Example Property Tests**:

```javascript
const fc = require('fast-check');

// Property 1: Admin-only button visibility
// Feature: user-management-ui-updates, Property 1: Admin-only button visibility
test('Password reset and delete buttons only appear for non-admin users', () => {
  fc.assert(
    fc.property(
      fc.array(fc.record({
        id: fc.string(),
        email: fc.emailAddress(),
        isAdmin: fc.boolean()
      })),
      (users) => {
        const renderedHTML = renderUserList(users);
        
        users.forEach(user => {
          const userCard = renderedHTML.querySelector(`[data-user-id="${user.id}"]`);
          const resetBtn = userCard.querySelector('.send-reset-btn');
          const deleteBtn = userCard.querySelector('.delete-user-btn');
          
          if (user.isAdmin) {
            expect(resetBtn).toBeNull();
            expect(deleteBtn).toBeNull();
          } else {
            expect(resetBtn).not.toBeNull();
            expect(deleteBtn).not.toBeNull();
          }
        });
      }
    ),
    { numRuns: 100 }
  );
});

// Property 13: Active filter badge display
// Feature: user-management-ui-updates, Property 13: Active filter badge display
test('Filter badge displays correct count of active filters', () => {
  fc.assert(
    fc.property(
      fc.record({
        department: fc.oneof(fc.constant('All'), fc.string()),
        semester: fc.oneof(fc.constant('All'), fc.string()),
        section: fc.oneof(fc.constant('All'), fc.string()),
        role: fc.oneof(fc.constant('All'), fc.string())
      }),
      (filters) => {
        const filterPopup = new FilterPopup();
        
        // Apply filters
        document.getElementById('filter-department').value = filters.department;
        document.getElementById('filter-semester').value = filters.semester;
        document.getElementById('filter-section').value = filters.section;
        document.getElementById('filter-role').value = filters.role;
        
        filterPopup.updateBadge();
        
        // Count expected active filters
        const expectedCount = [
          filters.department !== 'All',
          filters.semester !== 'All',
          filters.section !== 'All',
          filters.role !== 'All'
        ].filter(Boolean).length;
        
        expect(filterPopup.activeFilters).toBe(expectedCount);
        
        if (expectedCount > 0) {
          expect(filterPopup.badge.style.display).toBe('inline-flex');
          expect(filterPopup.badge.textContent).toBe(String(expectedCount));
        } else {
          expect(filterPopup.badge.style.display).toBe('none');
        }
      }
    ),
    { numRuns: 100 }
  );
});

// Property 17: API response format
// Feature: user-management-ui-updates, Property 17: API response format
test('All API responses contain required fields', () => {
  fc.assert(
    fc.property(
      fc.record({
        userId: fc.string(),
        isAdmin: fc.boolean(),
        shouldSucceed: fc.boolean()
      }),
      async (testCase) => {
        // Mock API call
        const response = await mockAPICall(
          testCase.userId, 
          testCase.isAdmin, 
          testCase.shouldSucceed
        );
        
        // Verify response structure
        expect(response).toHaveProperty('success');
        expect(typeof response.success).toBe('boolean');
        
        if (response.success) {
          expect(response).toHaveProperty('message');
          expect(typeof response.message).toBe('string');
        } else {
          expect(response).toHaveProperty('error');
          expect(typeof response.error).toBe('string');
        }
      }
    ),
    { numRuns: 100 }
  );
});
```

### Integration Testing

**Test Scenarios**:
1. Complete password reset flow (button click → API call → notification)
2. Complete user deletion flow (button click → confirmation → API call → UI update)
3. Filter application and user list updates
4. Error handling across all components

### Manual Testing Checklist

- [ ] Test on mobile devices (iOS Safari, Android Chrome)
- [ ] Test on desktop browsers (Chrome, Firefox, Safari, Edge)
- [ ] Verify keyboard navigation works for all interactive elements
- [ ] Test with screen reader for accessibility
- [ ] Verify all animations complete within 300ms
- [ ] Test with slow network conditions
- [ ] Verify error messages are user-friendly
- [ ] Test admin permission checks thoroughly

